services:
  # --- Database Initialization ---
  init-db:
    build: .
    volumes:
      - ./data:/app/data
      - ./ingestor:/app/ingestor
      - ./shared:/app/shared
    env_file:
      - .env
    command: python shared/schema.py
    restart: "no"

  # --- Ingestion Services ---
  market_harvester:
    build: .
    volumes:
      - ./data:/app/data
      - ./processor:/app/processor
      - ./shared:/app/shared
    env_file:
      - .env
    command: sh -c "while true; do python ingestor/market_harvester.py; python shared/smart_sleep.py; done"
    restart: unless-stopped
    depends_on:
      init-db:
        condition: service_completed_successfully

  # --- Processing Services ---
  ta_calculator:
    build: .
    volumes:
      - ./data:/app/data
    env_file:
      - .env
    command: sh -c "while true; do python processor/ta_calculator.py; python shared/smart_sleep.py; done"
    restart: unless-stopped
    depends_on:
      market_harvester:
        condition: service_started
      init-db:
        condition: service_completed_successfully

  predictive_engine:
    build: .
    shm_size: '2gb'
    volumes:
      - ./data:/app/data
      - ./processor:/app/processor
      - ./shared:/app/shared
      - ./hf_cache:/root/.cache/huggingface
    env_file:
      - .env
    command: python processor/predictive_engine.py
    restart: unless-stopped
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    depends_on:
      market_harvester:
        condition: service_started
      init-db:
        condition: service_completed_successfully

  # --- Strategy Services ---
  strategy_engine:
    build: .
    volumes:
      - ./data:/app/data
      - ./strategy:/app/strategy
      - ./shared:/app/shared
    env_file:
      - .env
    command: sh -c "while true; do python strategy/trend_following.py; python shared/smart_sleep.py; done"
    restart: unless-stopped
    depends_on:
      ta_calculator:
        condition: service_started
      predictive_engine:
        condition: service_started
      init-db:
        condition: service_completed_successfully

  # --- Execution Services ---
  risk_manager:
    build: .
    volumes:
      - ./data:/app/data
      - ./execution:/app/execution
      - ./shared:/app/shared
    env_file:
      - .env
    command: sh -c "while true; do python execution/risk_manager.py; python shared/smart_sleep.py; done"
    restart: unless-stopped
    depends_on:
      strategy_engine:
        condition: service_started
      init-db:
        condition: service_completed_successfully

  alpaca_executor:
    build: .
    volumes:
      - ./data:/app/data
      - ./execution:/app/execution
      - ./shared:/app/shared
    env_file:
      - .env
    command: sh -c "while true; do python execution/alpaca_executor.py; sleep 60; done"
    restart: unless-stopped
    depends_on:
      risk_manager:
        condition: service_started
      init-db:
        condition: service_completed_successfully

  # --- Dashboard ---
  dashboard:
    build: .
    volumes:
      - ./data:/app/data
      - ./dashboard:/app/dashboard
      - ./shared:/app/shared
    env_file:
      - .env
    command: streamlit run dashboard/app.py --server.port=8501 --server.address=0.0.0.0
    ports:
      - "8501:8501"
    restart: unless-stopped
    depends_on:
      init-db:
        condition: service_completed_successfully
